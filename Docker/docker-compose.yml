version: '3.7'

services:
    crashhub:
        build:
            context: ../
            dockerfile: $PWD/Crashhub/Dockerfile
            args:
                - appName
                - githubProject
                - githubToken
                - dbEngine
                - dbName
                - dbHost
                - dbPort
                - dbUser
                - dbPassword
        network_mode: host
        ports:
            - "${CRASHHUB_SERVICE_PORT}:8081"
        depends_on:
            - postgres
    postgres:
        image: postgres:11.4
        network_mode: host
        volumes:
            - crashhub_db:/var/lib/postgresql/data
        ports:
            - "${CRASHHUB_DB_PORT}:5432"
    nginx:
        image: nginx:latest
        network_mode: host
        ports:
            - "80:80"
        volumes:
            - "./Nginx/Crashhub.template:/etc/nginx/conf.d/Crashhub.template"
            - "web-root:/var/www/html"
        environment:
            - NGINX_HOST=${serverName}
        command: /bin/bash -c "envsubst < /etc/nginx/conf.d/Crashhub.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
    nginxSSL:
        image: nginx:latest
        network_mode: host
        ports:
            - "443:443"
        volumes:
            - "./Nginx/CrashhubSSL.template:/etc/nginx/conf.d/CrashhubSSL.template"
            - "/var/log/nginx/:/var/log/nginx/"
            - "certbot-etc:/etc/letsencrypt"
            - "certbot-var:/var/lib/letsencrypt"
        environment:
            - NGINX_HOST=${serverName}
        restart: always
        depends_on:
            - certbot
        command: /bin/bash -c "envsubst < /etc/nginx/conf.d/CrashhubSSL.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
    certbot:
        image: certbot/certbot
        volumes:
            - "certbot-etc:/etc/letsencrypt"
            - "certbot-var:/var/lib/letsencrypt"
            - "web-root:/var/www/html"
        depends_on:
            - nginx
        command: certonly --webroot --webroot-path=/var/www/html --email ${contactEmail} --agree-tos --no-eff-email --force-renewal --cert-name cosigner ${certDomains}
volumes:
        certbot-etc:
        certbot-var:
        web-root:
